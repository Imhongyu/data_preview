<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG数据一体化可视化系统</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(20, 20, 20, 0.9);
            padding: 20px 40px;
            border-bottom: 1px solid #333;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .header h1 {
            background: linear-gradient(45deg, #4a90e2, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .header p {
            color: #b0b0b0;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .main-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .nav-btn {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 10px 20px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .nav-btn.active {
            background: rgba(74, 144, 226, 0.3);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .nav-btn:hover {
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 10px 20px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mode-btn.active {
            background: rgba(74, 144, 226, 0.3);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .mode-btn:hover {
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-item label {
            color: #b0b0b0;
            font-size: 0.9rem;
            min-width: 60px;
        }

        .control-select, .control-input {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .control-select:focus, .control-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .control-btn {
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid #4a90e2;
            border-radius: 6px;
            padding: 8px 15px;
            color: #4a90e2;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: rgba(74, 144, 226, 0.4);
            color: #fff;
        }

        .view-toggle {
            display: flex;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle button {
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .view-toggle button.active {
            background: #4a90e2;
            color: #fff;
        }

        .loading {
            text-align: center;
            color: #4a90e2;
            padding: 20px;
            font-size: 1.1rem;
        }

        .main-area {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 0;
        }

        .sidebar {
            width: 380px;
            background: rgba(20, 20, 20, 0.9);
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h3 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .info-panel {
            background: rgba(40, 40, 40, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #00ff88;
            max-height: 500px;
            overflow-y: auto;
        }

        .info-panel h4 {
            color: #00ff88;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .info-panel .field {
            margin-bottom: 8px;
        }

        .info-panel .field-label {
            color: #4a90e2;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .info-panel .field-value {
            color: #b0b0b0;
            font-size: 0.8rem;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(40, 40, 40, 0.4);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            margin-top: 2px;
        }

        .content-area {
            flex: 1;
            position: relative;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .graph-container {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(74, 144, 226, 0.1) 0%, transparent 50%);
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .graph-canvas:active {
            cursor: grabbing;
        }

        .table-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 10, 0.5);
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
            padding: 20px;
            min-height: 0;
        }

        .table-controls {
            padding: 15px 20px;
            background: rgba(20, 20, 20, 0.9);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .table-controls .info {
            color: #b0b0b0;
            font-size: 0.9rem;
        }

        .table-controls .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 10px;
            border: 1px solid #333;
            text-align: left;
            font-size: 0.8rem;
            vertical-align: top;
        }

        .data-table th {
            background: rgba(40, 40, 40, 0.9);
            color: #4a90e2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            color: #b0b0b0;
            word-wrap: break-word;
            max-width: 200px;
        }

        .data-table tr:hover {
            background: rgba(74, 144, 226, 0.1);
        }

        .data-table tr.selected {
            background: rgba(74, 144, 226, 0.2);
        }

        .data-table .mandatory {
            color: #ff4757;
            font-weight: bold;
        }

        .data-table .optional {
            color: #7bed9f;
        }

        .data-table .required {
            color: #ff4757;
            font-weight: bold;
        }

        .data-table .cell-content {
            max-height: 60px;
            overflow: hidden;
            line-height: 1.4;
        }

        .data-table .cell-content.expanded {
            max-height: none;
        }

        .expand-btn {
            color: #4a90e2;
            cursor: pointer;
            font-size: 0.7rem;
            margin-top: 2px;
            display: inline-block;
        }

        .expand-btn:hover {
            color: #00ff88;
        }

        .column-toggle {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(40, 40, 40, 0.6);
            border-radius: 6px;
        }

        .column-toggle h4 {
            color: #4a90e2;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .column-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.3);
        }

        .node-circle {
            stroke-width: 2;
            transition: all 0.3s ease;
        }

        .node-text {
            fill: #ffffff;
            font-size: 10px;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            font-weight: 500;
        }

        .link {
            stroke: #555;
            stroke-width: 1;
            fill: none;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .link:hover {
            stroke: #4a90e2;
            opacity: 1;
            stroke-width: 2;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
            max-width: 200px;
        }

        .legend h4 {
            color: #4a90e2;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #555;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #4a90e2;
            border-radius: 6px;
            padding: 10px;
            color: #fff;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .error-message {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            border-radius: 6px;
            padding: 15px;
            color: #ff4757;
            margin: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 20, 20, 0.9);
            border-top: 1px solid #333;
        }

        .pagination button {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px 12px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .pagination button:hover,
        .pagination button.active {
            background: rgba(74, 144, 226, 0.3);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        /* Markdown 区域样式 */
        .markdown-area {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: rgba(10, 10, 10, 0.5);
        }

        .markdown-content {
            background: rgba(20, 20, 20, 0.9);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .markdown-content h1 {
            color: #4a90e2;
            border-bottom: 3px solid #4a90e2;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
            font-size: 2.5em;
        }

        .markdown-content h2 {
            color: #00ff88;
            border-left: 4px solid #00ff88;
            padding-left: 15px;
            margin: 25px 0 15px 0;
            font-size: 2em;
        }

        .markdown-content h3 {
            color: #ff6b6b;
            margin: 20px 0 10px 0;
            font-size: 1.5em;
        }

        .markdown-content p {
            margin: 15px 0;
            text-align: justify;
            font-size: 16px;
            color: #b0b0b0;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(40, 40, 40, 0.6);
        }

        .markdown-content th {
            background: rgba(74, 144, 226, 0.8);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .markdown-content td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            color: #b0b0b0;
        }

        .markdown-content tr:nth-child(even) {
            background-color: rgba(40, 40, 40, 0.3);
        }

        .markdown-content tr:hover {
            background-color: rgba(74, 144, 226, 0.2);
        }

        .markdown-content blockquote {
            border-left: 4px solid #4a90e2;
            margin: 20px 0;
            padding: 15px 20px;
            background: rgba(40, 40, 40, 0.6);
            border-radius: 0 10px 10px 0;
            font-style: italic;
            color: #b0b0b0;
        }

        .markdown-content code {
            background: rgba(40, 40, 40, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #00ff88;
        }

        .markdown-content pre {
            background: rgba(40, 40, 40, 0.8);
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .markdown-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: rgba(40, 40, 40, 0.6);
            border-radius: 10px;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            color: #4a90e2;
            font-weight: 600;
        }

        .toc {
            background: rgba(40, 40, 40, 0.6);
            border: 1px solid #555;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .toc h3 {
            color: #4a90e2;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding-left: 0;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #4a90e2;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .toc a:hover {
            background: #4a90e2;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 300px;
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ESG数据一体化可视化系统</h1>
            <p>集成ESG问卷数据和披露标准的综合分析平台</p>
            
            <div class="main-nav">
                <div class="nav-btn active" onclick="switchMainMode('data')">
                    📊 数据分析
                </div>
                <div class="nav-btn" onclick="switchMainMode('report')">
                    📄 报告展示
                </div>
            </div>

            <div id="dataControls" class="data-controls">
                <div class="mode-switcher">
                    <div class="mode-btn active" onclick="switchDataMode('questionnaire')">
                        📊 ESG问卷数据
                    </div>
                    <div class="mode-btn" onclick="switchDataMode('standards')">
                        📋 披露标准
                    </div>
                </div>

                <div class="controls">
                    <!-- 问卷模式控件 -->
                    <div id="questionnaireControls" class="questionnaire-controls">
                        <div class="control-item">
                            <label>ESG领域:</label>
                            <select class="control-select" id="domainSelect">
                                <option value="all">全部领域</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>主题:</label>
                            <select class="control-select" id="topicSelect">
                                <option value="all">全部主题</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>必填项:</label>
                            <select class="control-select" id="requiredSelect">
                                <option value="all">全部</option>
                                <option value="是">必填</option>
                                <option value="否">非必填</option>
                            </select>
                        </div>
                    </div>

                    <!-- 标准模式控件 -->
                    <div id="standardsControls" class="standards-controls hidden">
                        <div class="control-item">
                            <label>标准:</label>
                            <select class="control-select" id="standardSelect">
                                <option value="all">全部标准</option>
                                <option value="GRI">GRI</option>
                                <option value="SASB">SASB</option>
                                <option value="TCFD">TCFD</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>要求类型:</label>
                            <select class="control-select" id="typeSelect">
                                <option value="all">全部</option>
                                <option value="mandatory">强制性</option>
                                <option value="optional">可选性</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>行业:</label>
                            <select class="control-select" id="industrySelect">
                                <option value="all">全部行业</option>
                            </select>
                        </div>
                    </div>

                    <!-- 通用控件 -->
                    <div class="control-item">
                        <label>搜索:</label>
                        <input type="text" class="control-input" id="searchInput" placeholder="搜索内容...">
                    </div>

                    <div class="view-toggle">
                        <button class="active" onclick="switchView('graph')">图谱视图</button>
                        <button onclick="switchView('table')">表格视图</button>
                    </div>

                    <button class="control-btn hidden" onclick="resetView()" id="resetBtn">重置视图</button>
                    <button class="control-btn hidden" onclick="exportData()" id="exportBtn">导出数据</button>
                </div>
            </div>
        </div>

        <div class="main-area">
            <div class="loading" id="loading">正在加载数据...</div>
            
            <div class="sidebar hidden" id="sidebar">
                <h3 id="sidebarTitle">详细信息</h3>
                <div class="info-panel" id="infoPanel">
                    <h4>选择节点查看详情</h4>
                    <p>点击图谱中的任意节点或表格中的行，查看详细信息</p>
                </div>

                <h3>数据统计</h3>
                <div class="stats-grid" id="statsGrid">
                    <!-- 统计信息将动态生成 -->
                </div>
            </div>

            <div class="content-area hidden" id="contentArea">
                <div class="graph-container" id="graphContainer">
                    <svg class="graph-canvas" id="graphCanvas"></svg>
                    <div class="legend" id="legend">
                        <!-- 图例将动态生成 -->
                    </div>
                </div>

                <div class="table-container hidden" id="tableContainer">
                    <div class="table-controls" id="tableControls">
                        <div class="info" id="tableInfo">
                            显示数据统计信息
                        </div>
                        <div class="controls">
                            <select class="control-select" id="pageSizeSelect" onchange="changePageSize()">
                                <option value="25">25条/页</option>
                                <option value="50" selected>50条/页</option>
                                <option value="100">100条/页</option>
                                <option value="200">200条/页</option>
                            </select>
                            <button class="control-btn" onclick="toggleColumnSelector()">列设置</button>
                        </div>
                    </div>
                    
                    <div class="column-toggle hidden" id="columnSelector">
                        <h4>选择显示列</h4>
                        <div class="column-checkboxes" id="columnCheckboxes">
                            <!-- 列选择器将动态生成 -->
                        </div>
                    </div>

                    <div class="table-wrapper" id="tableWrapper">
                        <div id="tableContent">
                            <!-- 表格内容将动态生成 -->
                        </div>
                    </div>

                    <div class="pagination" id="pagination">
                        <!-- 分页将动态生成 -->
                    </div>
                </div>
            </div>

            <!-- Markdown 报告区域 -->
            <div class="markdown-area hidden" id="markdownArea">
                <div class="markdown-content" id="markdownContent">
                    <!-- Markdown 内容将动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // 全局变量
        let currentMainMode = 'data'; // 'data' 或 'report'
        let currentDataMode = 'questionnaire'; // 'questionnaire' 或 'standards'
        let currentView = 'graph'; // 'graph' 或 'table'
        let allData = [];
        let filteredData = [];
        let svg, g, simulation;
        let selectedNode = null;
        let currentPage = 1;
        let itemsPerPage = 50;

        // 数据文件配置
        const dataFiles = {
            questionnaire: 'data/ESG_Questionnaire_WithKeyIssues.xlsx',
            standards: {
                GRI: 'data/GRI_final_clauses.jsonl',
                SASB: 'data/SASB_final_clauses.jsonl',
                TCFD: 'data/TCFD_final_clauses.jsonl'
            }
        };

        const reportFile = 'data/ESG_Report_20250728_162554.md';

        // 问卷表格列配置
        let questionnaireColumns = {
            'indicatorId': { label: '指标ID', visible: true, width: '120px' },
            'indicatorName': { label: '指标名称', visible: true, width: '200px' },
            'esgDomain': { label: 'ESG领域', visible: true, width: '100px' },
            'topic': { label: '主题', visible: true, width: '120px' },
            'keyIssue': { label: '关键议题', visible: true, width: '150px' },
            'description': { label: '指标描述', visible: true, width: '250px' },
            'calculation': { label: '计算方法', visible: true, width: '200px' },
            'dataCollection': { label: '数据收集指导', visible: true, width: '200px' },
            'dataType': { label: '数据类型', visible: true, width: '100px' },
            'unit': { label: '建议单位', visible: true, width: '100px' },
            'required': { label: '是否必填', visible: true, width: '80px' },
            'reference': { label: '参考标准', visible: true, width: '150px' },
            'notes': { label: '披露注意事项', visible: true, width: '200px' },
            'actualData': { label: '实际披露数据', visible: true, width: '150px' },
            'reliability': { label: '数据可信度', visible: true, width: '100px' },
            'sampleData': { label: '假数据', visible: false, width: '150px' },
            'dataDescription': { label: '数据说明', visible: false, width: '200px' },
            'dataRemarks': { label: '数据备注', visible: false, width: '200px' },
            'sourceBatch': { label: '来源批次', visible: false, width: '100px' },
            'relatedClauseId': { label: '相关条款ID', visible: false, width: '150px' },
            'finalRemarks': { label: '最终备注', visible: false, width: '200px' }
        };

        // 标准表格列配置
        let standardsColumns = {
            'clause_id': { label: '条款ID', visible: true, width: '120px' },
            'clause_content': { label: '条款内容', visible: true, width: '300px' },
            'standard': { label: '标准', visible: true, width: '80px' },
            'mandatory_optional': { label: '类型', visible: true, width: '80px' },
            'applicable_industry': { label: '适用行业', visible: true, width: '120px' },
            'related_topics': { label: '相关主题', visible: true, width: '200px' },
            'related_clauses': { label: '相关条款', visible: true, width: '150px' },
            'original_text': { label: '原始文本', visible: false, width: '300px' },
            'auto_clause_number': { label: '自动编号', visible: false, width: '120px' }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeApp();
        });

        function setupEventListeners() {
            // 筛选器
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            
            // 初始化 Mermaid
            mermaid.initialize({ startOnLoad: true });
        }

        async function initializeApp() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('loading').textContent = '正在加载数据...';
                
                await loadDataFiles();
                
                initializeInterface();
                setupModeFilters();
                applyFilters();
                
                // 显示界面
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                document.getElementById('resetBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                
                if (currentView === 'graph') {
                    document.getElementById('graphContainer').classList.remove('hidden');
                    document.getElementById('tableContainer').classList.add('hidden');
                    initGraph();
                } else {
                    document.getElementById('graphContainer').classList.add('hidden');
                    document.getElementById('tableContainer').classList.remove('hidden');
                    generateTable();
                }
                
            } catch (error) {
                console.error('初始化失败:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error-message">
                        <h3>数据加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请确保所有数据文件都在正确的位置</p>
                        <button class="control-btn" onclick="location.reload()">重新加载</button>
                    </div>
                `;
            }
        }

        async function loadDataFiles() {
            allData = [];
            
            // 加载问卷数据
            try {
                const questionnaireResponse = await fetch(dataFiles.questionnaire);
                if (!questionnaireResponse.ok) throw new Error(`无法加载问卷数据: ${questionnaireResponse.status}`);
                
                const arrayBuffer = await questionnaireResponse.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const processedData = jsonData.map((row, index) => ({
                    id: index + 1,
                    type: 'questionnaire',
                    esgDomain: row['ESG领域'] || row['ESG_Domain'] || '',
                    topic: row['主题'] || row['Topic'] || '',
                    keyIssue: row['Key Issue'] || row['关键议题'] || '',
                    indicatorId: row['指标ID'] || row['Indicator_ID'] || '',
                    indicatorName: row['指标名称'] || row['Indicator_Name'] || '',
                    description: row['指标描述'] || row['Description'] || '',
                    calculation: row['计算方法'] || row['Calculation'] || '',
                    dataCollection: row['数据收集指导'] || row['Data_Collection'] || '',
                    dataType: row['数据类型'] || row['Data_Type'] || '',
                    unit: row['建议单位'] || row['Unit'] || '',
                    required: row['是否必填'] || row['Required'] || '',
                    reference: row['参考标准'] || row['Reference'] || '',
                    notes: row['披露注意事项'] || row['Notes'] || '',
                    sampleData: row['假数据'] || row['Sample_Data'] || '',
                    dataDescription: row['数据说明'] || row['Data_Description'] || '',
                    dataRemarks: row['数据备注'] || row['Data_Remarks'] || '',
                    reliability: row['数据可信度'] || row['Reliability'] || '',
                    sourceBatch: row['来源批次'] || row['Source_Batch'] || '',
                    relatedClauseId: row['相关条款ID'] || row['Related_Clause_ID'] || '',
                    actualData: row['实际披露数据'] || row['Actual_Data'] || '',
                    finalRemarks: row['最终备注'] || row['Final_Remarks'] || ''
                }));

                allData.push(...processedData);
            } catch (error) {
                console.error('加载问卷数据失败:', error);
            }

            // 加载标准数据
            for (const [standard, filename] of Object.entries(dataFiles.standards)) {
                try {
                    const response = await fetch(filename);
                    if (!response.ok) throw new Error(`无法加载${standard}数据: ${response.status}`);
                    
                    const text = await response.text();
                    const lines = text.split('\n').filter(line => line.trim());

                    const processedData = [];
                    for (const line of lines) {
                        try {
                            const item = JSON.parse(line);
                            processedData.push({
                                ...item,
                                type: 'standards',
                                standard: item.standard || item.applicable_standard || standard
                            });
                        } catch (parseError) {
                            console.warn('解析行失败:', line, parseError);
                        }
                    }

                    allData.push(...processedData);
                } catch (error) {
                    console.error(`加载${standard}数据失败:`, error);
                }
            }

            console.log(`成功加载 ${allData.length} 条数据`);
        }

        // 切换主模式
        function switchMainMode(mode) {
            currentMainMode = mode;
            
            // 更新按钮状态
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'data') {
                document.getElementById('dataControls').classList.remove('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                document.getElementById('markdownArea').classList.add('hidden');
            } else {
                document.getElementById('dataControls').classList.add('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('contentArea').classList.add('hidden');
                document.getElementById('markdownArea').classList.remove('hidden');
                loadMarkdownReport();
            }
        }

        async function loadMarkdownReport() {
            try {
                document.getElementById('markdownContent').innerHTML = '<div class="loading">正在加载报告...</div>';
                
                const response = await fetch(reportFile);
                if (!response.ok) throw new Error(`无法加载报告文件: ${response.status}`);
                
                const markdown = await response.text();
                await renderMarkdown(markdown);
                
            } catch (error) {
                console.error('加载报告失败:', error);
                document.getElementById('markdownContent').innerHTML = `
                    <div class="error-message">
                        <h3>报告加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请确保报告文件存在且可访问</p>
                    </div>
                `;
            }
        }

        async function renderMarkdown(markdown) {
            // 处理图表代码块
            const processedMarkdown = processChartBlocks(markdown);

            // 渲染 Markdown
            const html = marked.parse(processedMarkdown);
            document.getElementById('markdownContent').innerHTML = html;

            // 生成目录
            generateTableOfContents();

            // 渲染图表
            renderCharts();

            // 增强表格
            enhanceTables();
        }

        function processChartBlocks(markdown) {
            return markdown.replace(/```chart\n([\s\S]*?)```/g, (match, chartData) => {
                const id = 'chart_' + Math.random().toString(36).substr(2, 9);
                return `<div class="chart-container">
                    <canvas id="${id}" data-chart='${chartData.trim()}'></canvas>
                </div>`;
            });
        }

        function renderCharts() {
            const charts = document.querySelectorAll('canvas[data-chart]');
            charts.forEach(canvas => {
                try {
                    const chartData = canvas.getAttribute('data-chart');
                    const config = parseChartConfig(chartData);
                    new Chart(canvas, config);
                } catch (error) {
                    console.error('图表渲染错误:', error);
                }
            });
        }

        function parseChartConfig(dataString) {
            const lines = dataString.split('\n');
            const config = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '图表'
                        }
                    }
                }
            };

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('type:')) {
                    config.type = line.split(':')[1].trim();
                } else if (line.startsWith('title:')) {
                    config.options.plugins.title.text = line.split(':')[1].trim();
                } else if (line.includes('labels:')) {
                    const match = line.match(/\[(.*?)\]/);
                    if (match) {
                        config.data.labels = match[1].split(',').map(s => s.trim().replace(/"/g, ''));
                    }
                } else if (line.includes('label:')) {
                    const label = line.split(':')[1].trim().replace(/"/g, '');
                    const dataset = { label, data: [], borderColor: getRandomColor(), backgroundColor: getRandomColor(0.2) };
                    config.data.datasets.push(dataset);
                } else if (line.includes('data:') && config.data.datasets.length > 0) {
                    const match = line.match(/\[(.*?)\]/);
                    if (match) {
                        const lastDataset = config.data.datasets[config.data.datasets.length - 1];
                        lastDataset.data = match[1].split(',').map(s => parseFloat(s.trim()));
                    }
                } else if (line.includes('colors:')) {
                    const match = line.match(/\[(.*?)\]/);
                    if (match) {
                        const colors = match[1].split(',').map(s => s.trim().replace(/"/g, ''));
                        config.data.datasets.forEach((dataset, index) => {
                            if (colors[index]) {
                                dataset.backgroundColor = colors[index];
                                dataset.borderColor = colors[index];
                            }
                        });
                    }
                }
            });

            // 饼图特殊处理
            if (config.type === 'pie' && lines.some(line => line.includes('data:') && !line.includes('datasets'))) {
                const dataLine = lines.find(line => line.includes('data:') && !line.includes('datasets'));
                const match = dataLine.match(/\[(.*?)\]/);
                if (match) {
                    const data = match[1].split(',').map(s => parseFloat(s.trim()));
                    config.data.datasets = [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                        ]
                    }];
                }
            }

            return config;
        }

        function getRandomColor(alpha = 1) {
            const colors = [
                `rgba(74, 144, 226, ${alpha})`,
                `rgba(0, 255, 136, ${alpha})`,
                `rgba(255, 107, 107, ${alpha})`,
                `rgba(255, 211, 61, ${alpha})`,
                `rgba(153, 102, 255, ${alpha})`,
                `rgba(255, 159, 64, ${alpha})`
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function generateTableOfContents() {
            const headings = document.querySelectorAll('.markdown-content h1, .markdown-content h2, .markdown-content h3');
            if (headings.length === 0) return;

            const toc = document.createElement('div');
            toc.className = 'toc';
            toc.innerHTML = '<h3>📋 目录</h3><ul></ul>';
            const ul = toc.querySelector('ul');

            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = heading.textContent;
                a.style.paddingLeft = (heading.tagName === 'H2' ? '20px' : heading.tagName === 'H3' ? '40px' : '0');
                
                li.appendChild(a);
                ul.appendChild(li);
            });

            const markdownContent = document.getElementById('markdownContent');
            markdownContent.insertBefore(toc, markdownContent.firstChild);
        }

        function enhanceTables() {
            const tables = document.querySelectorAll('.markdown-content table');
            tables.forEach(table => {
                // 检查是否包含数字数据，如果是则尝试生成图表
                const rows = Array.from(table.querySelectorAll('tr'));
                if (rows.length > 1) {
                    const headers = Array.from(rows[0].querySelectorAll('th, td')).map(cell => cell.textContent.trim());
                    const data = rows.slice(1).map(row => 
                        Array.from(row.querySelectorAll('td')).map(cell => cell.textContent.trim())
                    );

                    // 如果表格包含数值数据，添加一个"生成图表"按钮
                    if (hasNumericData(data)) {
                        const button = document.createElement('button');
                        button.textContent = '📊 生成图表';
                        button.className = 'control-btn';
                        button.style.marginTop = '10px';
                        button.onclick = () => generateChartFromTable(headers, data, table);
                        table.parentNode.insertBefore(button, table.nextSibling);
                    }
                }
            });
        }

        function hasNumericData(data) {
            return data.some(row => 
                row.some(cell => !isNaN(parseFloat(cell)) && isFinite(cell))
            );
        }

        function generateChartFromTable(headers, data, table) {
            const canvas = document.createElement('canvas');
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.appendChild(canvas);
            table.parentNode.insertBefore(container, table.nextSibling.nextSibling);

            // 尝试自动检测数据结构并生成合适的图表
            const numericColumns = [];
            headers.forEach((header, index) => {
                if (data.every(row => !isNaN(parseFloat(row[index])) && isFinite(row[index]))) {
                    numericColumns.push(index);
                }
            });

            if (numericColumns.length > 0) {
                const config = {
                    type: 'bar',
                    data: {
                        labels: data.map(row => row[0]),
                        datasets: numericColumns.map((colIndex, i) => ({
                            label: headers[colIndex],
                            data: data.map(row => parseFloat(row[colIndex])),
                            backgroundColor: getRandomColor(0.7),
                            borderColor: getRandomColor(1),
                            borderWidth: 1
                        }))
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '基于表格数据生成的图表'
                            }
                        }
                    }
                };

                new Chart(canvas, config);
            }
        }

        // 切换数据模式
        function switchDataMode(mode) {
            currentDataMode = mode;
            
            // 更新按钮状态
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新界面
            updateUIForMode();
            
            // 重新应用筛选
            applyFilters();
        }

        function updateUIForMode() {
            const questionnaireControls = document.getElementById('questionnaireControls');
            const standardsControls = document.getElementById('standardsControls');

            if (currentDataMode === 'questionnaire') {
                questionnaireControls.classList.remove('hidden');
                standardsControls.classList.add('hidden');
                document.getElementById('searchInput').placeholder = '搜索指标名称...';
            } else {
                questionnaireControls.classList.add('hidden');
                standardsControls.classList.remove('hidden');
                document.getElementById('searchInput').placeholder = '搜索条款内容...';
            }
        }

        // 初始化界面
        function initializeInterface() {
            if (currentDataMode === 'questionnaire') {
                initQuestionnaireInterface();
            } else {
                initStandardsInterface();
            }
            updateStats();
            setupColumnSelector();
        }

        function initQuestionnaireInterface() {
            // 填充ESG领域选择器
            const questionnaireData = allData.filter(d => d.type === 'questionnaire');
            const domains = [...new Set(questionnaireData.map(d => d.esgDomain))].filter(d => d);
            const domainSelect = document.getElementById('domainSelect');
            domainSelect.innerHTML = '<option value="all">全部领域</option>';
            domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainSelect.appendChild(option);
            });

            // 填充主题选择器
            const topics = [...new Set(questionnaireData.map(d => d.topic))].filter(d => d);
            const topicSelect = document.getElementById('topicSelect');
            topicSelect.innerHTML = '<option value="all">全部主题</option>';
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });

            document.getElementById('sidebarTitle').textContent = '指标详情';
        }

        function initStandardsInterface() {
            // 填充行业选择器
            const standardsData = allData.filter(d => d.type === 'standards');
            const industries = [...new Set(standardsData.map(d => d.applicable_industry))].filter(d => d);
            const industrySelect = document.getElementById('industrySelect');
            industrySelect.innerHTML = '<option value="all">全部行业</option>';
            industries.forEach(industry => {
                if (industry && industry !== 'general') {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    industrySelect.appendChild(option);
                }
            });

            // 填充标准选择器
            const standards = [...new Set(standardsData.map(d => d.standard))].filter(d => d);
            const standardSelect = document.getElementById('standardSelect');
            standardSelect.innerHTML = '<option value="all">全部标准</option>';
            standards.forEach(standard => {
                const option = document.createElement('option');
                option.value = standard;
                option.textContent = standard;
                standardSelect.appendChild(option);
            });

            document.getElementById('sidebarTitle').textContent = '条款详情';
        }

        function setupModeFilters() {
            // 移除旧的事件监听器
            const selects = document.querySelectorAll('.control-select');
            selects.forEach(select => {
                select.removeEventListener('change', applyFilters);
                select.addEventListener('change', applyFilters);
            });
        }

        // 设置列选择器
        function setupColumnSelector() {
            const columns = currentDataMode === 'questionnaire' ? questionnaireColumns : standardsColumns;
            const container = document.getElementById('columnCheckboxes');
            
            container.innerHTML = '';
            Object.keys(columns).forEach(key => {
                const div = document.createElement('div');
                div.className = 'column-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="col_${key}" ${columns[key].visible ? 'checked' : ''} 
                           onchange="toggleColumn('${key}')">
                    <label for="col_${key}">${columns[key].label}</label>
                `;
                container.appendChild(div);
            });
        }

        function toggleColumn(columnKey) {
            const columns = currentDataMode === 'questionnaire' ? questionnaireColumns : standardsColumns;
            columns[columnKey].visible = !columns[columnKey].visible;
            generateTable();
        }

        function toggleColumnSelector() {
            const selector = document.getElementById('columnSelector');
            selector.classList.toggle('hidden');
        }

        function changePageSize() {
            itemsPerPage = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            generateTable();
        }

        // 应用筛选
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();

            if (currentDataMode === 'questionnaire') {
                applyQuestionnaireFilters(search);
            } else {
                applyStandardsFilters(search);
            }

            updateStats();
            currentPage = 1; // 重置页码

            if (currentView === 'graph' && svg) {
                updateGraph();
            } else if (currentView === 'table') {
                generateTable();
            }
        }

        function applyQuestionnaireFilters(search) {
            const domain = document.getElementById('domainSelect').value;
            const topic = document.getElementById('topicSelect').value;
            const required = document.getElementById('requiredSelect').value;

            filteredData = allData.filter(item => {
                if (item.type !== 'questionnaire') return false;
                if (domain !== 'all' && item.esgDomain !== domain) return false;
                if (topic !== 'all' && item.topic !== topic) return false;
                if (required !== 'all' && item.required !== required) return false;
                if (search && !item.indicatorName.toLowerCase().includes(search) && 
                    !item.description.toLowerCase().includes(search)) return false;
                return true;
            });
        }

        function applyStandardsFilters(search) {
            const standard = document.getElementById('standardSelect').value;
            const type = document.getElementById('typeSelect').value;
            const industry = document.getElementById('industrySelect').value;

            filteredData = allData.filter(item => {
                if (item.type !== 'standards') return false;
                if (standard !== 'all' && item.standard !== standard) return false;
                if (type !== 'all' && item.mandatory_optional !== type) return false;
                if (industry !== 'all' && item.applicable_industry !== industry) return false;
                if (search && !item.clause_content.toLowerCase().includes(search) && 
                    !item.original_text.toLowerCase().includes(search)) return false;
                return true;
            });
        }

        // 更新统计信息
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            if (currentDataMode === 'questionnaire') {
                updateQuestionnaireStats(statsGrid);
            } else {
                updateStandardsStats(statsGrid);
            }
        }

        function updateQuestionnaireStats(statsGrid) {
            const requiredCount = filteredData.filter(d => d.required === '是').length;
            const domains = new Set(filteredData.map(d => d.esgDomain).filter(d => d));
            const types = new Set(filteredData.map(d => d.dataType).filter(d => d));
            const withData = filteredData.filter(d => d.actualData && d.actualData.trim()).length;
            const completionRate = filteredData.length > 0 ? Math.round((withData / filteredData.length) * 100) : 0;
            const reliabilityValues = filteredData.map(d => parseFloat(d.reliability)).filter(v => !isNaN(v));
            const avgReliability = reliabilityValues.length > 0 ? 
                (reliabilityValues.reduce((a, b) => a + b, 0) / reliabilityValues.length).toFixed(1) : 0;

            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${filteredData.length}</div>
                    <div class="stat-label">指标总数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${requiredCount}</div>
                    <div class="stat-label">必填指标</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${domains.size}</div>
                    <div class="stat-label">ESG领域</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${types.size}</div>
                    <div class="stat-label">数据类型</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${completionRate}%</div>
                    <div class="stat-label">填报率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${avgReliability}</div>
                    <div class="stat-label">平均可信度</div>
                </div>
            `;
        }

        function updateStandardsStats(statsGrid) {
            const mandatoryCount = filteredData.filter(d => d.mandatory_optional === 'mandatory').length;
            const optionalCount = filteredData.filter(d => d.mandatory_optional === 'optional').length;
            const standards = new Set(filteredData.map(d => d.standard).filter(d => d));
            const topics = new Set();
            filteredData.forEach(d => {
                if (d.related_topics) {
                    d.related_topics.split(',').forEach(topic => topics.add(topic.trim()));
                }
            });

            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${filteredData.length}</div>
                    <div class="stat-label">条款总数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${mandatoryCount}</div>
                    <div class="stat-label">强制性</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${optionalCount}</div>
                    <div class="stat-label">可选性</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${standards.size}</div>
                    <div class="stat-label">标准数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${topics.size}</div>
                    <div class="stat-label">主题数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${Math.round((mandatoryCount / Math.max(filteredData.length, 1)) * 100)}%</div>
                    <div class="stat-label">强制性比例</div>
                </div>
            `;
        }

        // 切换视图
        function switchView(view) {
            currentView = view;
            
            // 更新按钮状态
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'graph') {
                document.getElementById('graphContainer').classList.remove('hidden');
                document.getElementById('tableContainer').classList.add('hidden');
                if (allData.length > 0 && !svg) {
                    initGraph();
                } else if (svg) {
                    updateGraph();
                }
            } else {
                document.getElementById('graphContainer').classList.add('hidden');
                document.getElementById('tableContainer').classList.remove('hidden');
                generateTable();
            }
        }

        // 生成图谱数据
        function generateGraphData() {
            if (currentDataMode === 'questionnaire') {
                return generateQuestionnaireGraphData();
            } else {
                return generateStandardsGraphData();
            }
        }

        function generateQuestionnaireGraphData() {
            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // 创建ESG领域节点
            const domains = [...new Set(filteredData.map(d => d.esgDomain))].filter(d => d);
            domains.forEach(domain => {
                const node = { id: `domain_${domain}`, name: domain, type: 'esg-domain', group: 'domain' };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // 创建主题节点
            const topics = [...new Set(filteredData.map(d => d.topic))].filter(d => d);
            topics.forEach(topic => {
                const node = {
                    id: `topic_${topic}`,
                    name: topic.length > 12 ? topic.substring(0, 10) + '...' : topic,
                    fullName: topic,
                    type: 'topic',
                    group: 'topic'
                };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // 采样指标
            let indicatorsToShow = filteredData;
            if (filteredData.length > 150) {
                indicatorsToShow = filteredData.sort(() => 0.5 - Math.random()).slice(0, 150);
            }

            // 创建指标节点
            indicatorsToShow.forEach(indicator => {
                const indicatorNode = {
                    id: `indicator_${indicator.indicatorId}`,
                    name: indicator.indicatorId,
                    fullName: indicator.indicatorName,
                    type: indicator.required === '是' ? 'required' : 'optional',
                    group: 'indicator',
                    data: indicator
                };
                nodes.push(indicatorNode);
                nodeMap.set(indicatorNode.id, indicatorNode);

                // 建立连接
                if (indicator.esgDomain) {
                    const domainId = `domain_${indicator.esgDomain}`;
                    if (nodeMap.has(domainId)) {
                        links.push({ source: domainId, target: indicatorNode.id, type: 'domain_indicator' });
                    }
                }

                if (indicator.topic) {
                    const topicId = `topic_${indicator.topic}`;
                    if (nodeMap.has(topicId)) {
                        links.push({ source: topicId, target: indicatorNode.id, type: 'topic_indicator' });
                    }
                }
            });

            return { nodes, links };
        }

        function generateStandardsGraphData() {
            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // 创建标准节点
            const standards = [...new Set(filteredData.map(d => d.standard))].filter(d => d);
            standards.forEach(standard => {
                const node = { id: `standard_${standard}`, name: standard, type: 'standard', group: standard };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // 创建主题节点
            const topics = new Set();
            filteredData.forEach(d => {
                if (d.related_topics) {
                    d.related_topics.split(',').forEach(topic => {
                        const trimmedTopic = topic.trim();
                        if (trimmedTopic && trimmedTopic.length > 1) topics.add(trimmedTopic);
                    });
                }
            });

            // 只保留频繁出现的主题
            const topicFreq = new Map();
            filteredData.forEach(d => {
                if (d.related_topics) {
                    d.related_topics.split(',').forEach(topic => {
                        const trimmedTopic = topic.trim();
                        if (trimmedTopic && trimmedTopic.length > 1) {
                            topicFreq.set(trimmedTopic, (topicFreq.get(trimmedTopic) || 0) + 1);
                        }
                    });
                }
            });

            const frequentTopics = Array.from(topicFreq.entries())
                .filter(([topic, freq]) => freq > 1)
                .map(([topic, freq]) => topic);

            frequentTopics.forEach(topic => {
                const node = {
                    id: `topic_${topic}`,
                    name: topic.length > 15 ? topic.substring(0, 12) + '...' : topic,
                    fullName: topic,
                    type: 'topic',
                    group: 'topic'
                };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // 采样条款
            let clausesToShow = filteredData;
            if (filteredData.length > 200) {
                clausesToShow = filteredData.sort(() => 0.5 - Math.random()).slice(0, 200);
            }

            // 创建条款节点
            clausesToShow.forEach(clause => {
                const clauseNode = {
                    id: `clause_${clause.clause_id}`,
                    name: clause.clause_id,
                    type: clause.mandatory_optional || 'unknown',
                    group: clause.standard,
                    data: clause
                };
                nodes.push(clauseNode);
                nodeMap.set(clauseNode.id, clauseNode);

                // 建立连接
                const standardId = `standard_${clause.standard}`;
                if (nodeMap.has(standardId)) {
                    links.push({ source: standardId, target: clauseNode.id, type: 'standard_clause' });
                }

                if (clause.related_topics) {
                    clause.related_topics.split(',').forEach(topic => {
                        const trimmedTopic = topic.trim();
                        if (frequentTopics.includes(trimmedTopic)) {
                            const topicId = `topic_${trimmedTopic}`;
                            if (nodeMap.has(topicId)) {
                                links.push({ source: topicId, target: clauseNode.id, type: 'topic_clause' });
                            }
                        }
                    });
                }
            });

            return { nodes, links };
        }

        // 初始化图谱
        function initGraph() {
            const container = document.getElementById('graphCanvas');
            const rect = container.getBoundingClientRect();
            
            svg = d3.select('#graphCanvas')
                .attr('width', rect.width)
                .attr('height', rect.height);

            g = svg.append('g');

            // 添加缩放和拖拽
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // 创建力导向布局
            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(rect.width / 2, rect.height / 2))
                .force('collision', d3.forceCollide().radius(20));

            updateGraph();
            updateLegend();
        }

        // 更新图谱
        function updateGraph() {
            if (!svg) return;

            const graphData = generateGraphData();
            const { nodes, links } = graphData;

            // 清空现有内容
            g.selectAll('*').remove();

            // 绘制连线
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .style('stroke', d => {
                    switch(d.type) {
                        case 'domain_indicator': return '#00ff88';
                        case 'topic_indicator': return '#ff6b6b';
                        case 'standard_clause': return '#4a90e2';
                        case 'topic_clause': return '#ff6b6b';
                        default: return '#555';
                    }
                })
                .style('stroke-width', 2)
                .style('opacity', 0.6);

            // 绘制节点
            const node = g.append('g')
                .selectAll('.node')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('click', selectNode)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            // 节点圆圈
            node.append('circle')
                .attr('class', d => `node-circle ${d.type}`)
                .attr('r', d => {
                    switch(d.type) {
                        case 'esg-domain': case 'standard': return 25;
                        case 'topic': return 18;
                        case 'key-issue': return 15;
                        case 'required': case 'mandatory': return 8;
                        case 'optional': return 8;
                        default: return 10;
                    }
                })
                .style('fill', d => getNodeColor(d.type))
                .style('stroke', '#4a90e2')
                .style('stroke-width', 2);

            // 节点文字
            node.append('text')
                .attr('class', 'node-text')
                .text(d => {
                    if (d.type === 'required' || d.type === 'optional' || d.type === 'mandatory') {
                        return '';
                    }
                    return d.name;
                })
                .style('fill', '#ffffff')
                .style('font-size', d => d.type === 'esg-domain' || d.type === 'standard' ? '12px' : '10px')
                .style('text-anchor', 'middle')
                .style('dominant-baseline', 'central')
                .style('pointer-events', 'none');

            // 更新力导向布局
            simulation.nodes(nodes);
            simulation.force('link').links(links);
            simulation.alpha(1).restart();

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function getNodeColor(type) {
            const colors = {
                'esg-domain': '#00ff88',
                'standard': '#00ff88',
                'topic': '#ff6b6b',
                'key-issue': '#ffd93d',
                'required': '#ff4757',
                'mandatory': '#ff4757',
                'optional': '#7bed9f'
            };
            return colors[type] || '#4a90e2';
        }

        function updateLegend() {
            const legend = document.getElementById('legend');
            
            if (currentDataMode === 'questionnaire') {
                legend.innerHTML = `
                    <h4>节点类型</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff88;"></div>
                        <span>ESG领域</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>主题</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4757;"></div>
                        <span>必填指标</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #7bed9f;"></div>
                        <span>可选指标</span>
                    </div>
                `;
            } else {
                legend.innerHTML = `
                    <h4>节点类型</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff88;"></div>
                        <span>披露标准</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>相关主题</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4757;"></div>
                        <span>强制性条款</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #7bed9f;"></div>
                        <span>可选性条款</span>
                    </div>
                `;
            }
        }

        // 生成表格
        function generateTable() {
            const totalItems = filteredData.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageData = filteredData.slice(startIndex, endIndex);

            // 更新表格信息
            document.getElementById('tableInfo').textContent = 
                `显示第 ${startIndex + 1} - ${endIndex} 条，共 ${totalItems} 条数据`;

            let tableHTML = '';

            if (currentDataMode === 'questionnaire') {
                tableHTML = generateQuestionnaireTable(pageData);
            } else {
                tableHTML = generateStandardsTable(pageData);
            }

            document.getElementById('tableContent').innerHTML = tableHTML;

            // 生成分页
            generatePagination(currentPage, totalPages, totalItems);

            // 添加行点击事件
            const rows = document.querySelectorAll('.data-table tbody tr');
            rows.forEach((row, index) => {
                row.addEventListener('click', () => {
                    rows.forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    updateInfoPanel(pageData[index]);
                });
            });
        }

        function generateQuestionnaireTable(data) {
            const visibleColumns = Object.keys(questionnaireColumns).filter(key => questionnaireColumns[key].visible);
            
            let html = `<table class="data-table"><thead><tr>`;
            
            // 生成表头
            visibleColumns.forEach(key => {
                html += `<th style="min-width: ${questionnaireColumns[key].width}">${questionnaireColumns[key].label}</th>`;
            });
            html += '</tr></thead><tbody>';

            // 生成数据行
            data.forEach(item => {
                html += '<tr>';
                visibleColumns.forEach(key => {
                    let value = item[key] || '';
                    let cellClass = '';
                    let cellContent = '';

                    // 特殊处理某些字段
                    if (key === 'required') {
                        cellClass = value === '是' ? 'required' : '';
                    }

                    // 处理长文本字段
                    if (['description', 'calculation', 'dataCollection', 'notes'].includes(key) && value.length > 100) {
                        const shortText = value.substring(0, 100) + '...';
                        cellContent = `
                            <div class="cell-content" id="cell_${item.id}_${key}">
                                ${shortText}
                            </div>
                            <span class="expand-btn" onclick="toggleCellExpansion('${item.id}', '${key}', \`${value.replace(/`/g, '\\`')}\`)">
                                展开
                            </span>
                        `;
                    } else {
                        cellContent = value;
                    }

                    html += `<td class="${cellClass}" title="${value}">${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function generateStandardsTable(data) {
            const visibleColumns = Object.keys(standardsColumns).filter(key => standardsColumns[key].visible);
            
            let html = `<table class="data-table"><thead><tr>`;
            
            // 生成表头
            visibleColumns.forEach(key => {
                html += `<th style="min-width: ${standardsColumns[key].width}">${standardsColumns[key].label}</th>`;
            });
            html += '</tr></thead><tbody>';

            // 生成数据行
            data.forEach(item => {
                html += '<tr>';
                visibleColumns.forEach(key => {
                    let value = item[key] || '';
                    let cellClass = '';
                    let cellContent = '';

                    // 特殊处理某些字段
                    if (key === 'mandatory_optional') {
                        cellClass = value;
                        value = value === 'mandatory' ? '强制性' : '可选性';
                    }

                    // 处理长文本字段
                    if (['clause_content', 'original_text'].includes(key) && value.length > 150) {
                        const shortText = value.substring(0, 150) + '...';
                        cellContent = `
                            <div class="cell-content" id="cell_${item.clause_id}_${key}">
                                ${shortText}
                            </div>
                            <span class="expand-btn" onclick="toggleCellExpansion('${item.clause_id}', '${key}', \`${value.replace(/`/g, '\\`')}\`)">
                                展开
                            </span>
                        `;
                    } else {
                        cellContent = value;
                    }

                    html += `<td class="${cellClass}" title="${value}">${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function toggleCellExpansion(id, key, fullText) {
            const cell = document.getElementById(`cell_${id}_${key}`);
            const expandBtn = cell.nextElementSibling;
            
            if (cell.classList.contains('expanded')) {
                // 收起
                const shortText = fullText.substring(0, currentDataMode === 'questionnaire' ? 100 : 150) + '...';
                cell.innerHTML = shortText;
                cell.classList.remove('expanded');
                expandBtn.textContent = '展开';
            } else {
                // 展开
                cell.innerHTML = fullText;
                cell.classList.add('expanded');
                expandBtn.textContent = '收起';
            }
        }

        function generatePagination(current, total, totalItems) {
            const pagination = document.getElementById('pagination');
            let html = '';

            if (current > 1) {
                html += `<button onclick="changePage(${current - 1})">上一页</button>`;
            }

            const startPage = Math.max(1, current - 2);
            const endPage = Math.min(total, current + 2);

            if (startPage > 1) {
                html += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<button disabled>...</button>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === current ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < total) {
                if (endPage < total - 1) {
                    html += `<button disabled>...</button>`;
                }
                html += `<button onclick="changePage(${total})">${total}</button>`;
            }

            if (current < total) {
                html += `<button onclick="changePage(${current + 1})">下一页</button>`;
            }

            pagination.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            generateTable();
        }

        // 选择节点/更新信息面板
        function selectNode(event, d) {
            selectedNode = d;
            
            // 高亮选中节点
            g.selectAll('.node-circle').style('stroke-width', 2);
            d3.select(event.currentTarget).select('.node-circle').style('stroke-width', 4);

            updateInfoPanel(d.data || d);
        }

        function updateInfoPanel(data) {
            const infoPanel = document.getElementById('infoPanel');
            
            if (currentDataMode === 'questionnaire') {
                updateQuestionnaireInfo(infoPanel, data);
            } else {
                updateStandardsInfo(infoPanel, data);
            }
        }

        function updateQuestionnaireInfo(panel, data) {
            if (data.indicatorId) {
                // 指标数据
                panel.innerHTML = `
                    <h4>${data.indicatorName}</h4>
                    <div class="field">
                        <div class="field-label">指标ID:</div>
                        <div class="field-value">${data.indicatorId}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">ESG领域:</div>
                        <div class="field-value">${data.esgDomain}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">主题:</div>
                        <div class="field-value">${data.topic}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">关键议题:</div>
                        <div class="field-value">${data.keyIssue}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">指标描述:</div>
                        <div class="field-value">${data.description}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">计算方法:</div>
                        <div class="field-value">${data.calculation}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">数据收集指导:</div>
                        <div class="field-value">${data.dataCollection}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">数据类型:</div>
                        <div class="field-value">${data.dataType}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">是否必填:</div>
                        <div class="field-value" style="color: ${data.required === '是' ? '#ff4757' : '#7bed9f'}">${data.required}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">建议单位:</div>
                        <div class="field-value">${data.unit}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">参考标准:</div>
                        <div class="field-value">${data.reference}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">披露注意事项:</div>
                        <div class="field-value">${data.notes}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">实际披露数据:</div>
                        <div class="field-value" style="color: ${data.actualData ? '#00ff88' : '#ff4757'}">${data.actualData || '未填报'}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">数据可信度:</div>
                        <div class="field-value">${data.reliability}</div>
                    </div>
                `;
            } else {
                // 分类节点
                panel.innerHTML = `
                    <h4>${data.fullName || data.name}</h4>
                    <div class="field">
                        <div class="field-label">类型:</div>
                        <div class="field-value">${data.type === 'esg-domain' ? 'ESG领域' : '主题'}</div>
                    </div>
                `;
            }
        }

        function updateStandardsInfo(panel, data) {
            if (data.clause_id) {
                // 条款数据
                panel.innerHTML = `
                    <h4>${data.clause_id}</h4>
                    <div class="field">
                        <div class="field-label">条款内容:</div>
                        <div class="field-value">${data.clause_content}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">原始文本:</div>
                        <div class="field-value">${data.original_text}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">类型:</div>
                        <div class="field-value">${data.mandatory_optional === 'mandatory' ? '强制性' : '可选性'}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">适用标准:</div>
                        <div class="field-value">${data.standard}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">适用行业:</div>
                        <div class="field-value">${data.applicable_industry}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">相关主题:</div>
                        <div class="field-value">${data.related_topics || '无'}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">相关条款:</div>
                        <div class="field-value">${data.related_clauses || '无'}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">自动编号:</div>
                        <div class="field-value">${data.auto_clause_number}</div>
                    </div>
                `;
            } else {
                // 分类节点
                panel.innerHTML = `
                    <h4>${data.fullName || data.name}</h4>
                    <div class="field">
                        <div class="field-label">类型:</div>
                        <div class="field-value">${data.type === 'standard' ? '披露标准' : '相关主题'}</div>
                    </div>
                `;
            }
        }

        // 显示提示信息
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            let content = `<strong>${d.fullName || d.name}</strong><br>类型: ${d.type}`;
            
            if (d.data) {
                if (currentDataMode === 'questionnaire') {
                    content += `<br>描述: ${d.data.description.substring(0, 80)}...`;
                    content += `<br>必填: ${d.data.required}`;
                } else {
                    content += `<br>内容: ${d.data.clause_content.substring(0, 80)}...`;
                    content += `<br>类型: ${d.data.mandatory_optional}`;
                }
            }
            
            tooltip.innerHTML = content;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        // 拖拽函数
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // 重置视图
        function resetView() {
            if (svg) {
                svg.transition().duration(750)
                    .call(d3.zoom().transform, d3.zoomIdentity);
            }
        }

        // 导出数据
        function exportData() {
            const dataStr = JSON.stringify(filteredData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `esg_${currentDataMode}_filtered.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 窗口大小改变时重新调整
        window.addEventListener('resize', function() {
            if (svg) {
                const container = document.getElementById('graphCanvas');
                const rect = container.getBoundingClientRect();
                svg.attr('width', rect.width).attr('height', rect.height);
                simulation.force('center', d3.forceCenter(rect.width / 2, rect.height / 2));
                simulation.alpha(1).restart();
            }
        });
    </script>
</body>
</html>
