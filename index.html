<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESGæ•°æ®ä¸€ä½“åŒ–å¯è§†åŒ–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(20, 20, 20, 0.9);
            padding: 20px 40px;
            border-bottom: 1px solid #333;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .header h1 {
            background: linear-gradient(45deg, #4a90e2, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .header p {
            color: #b0b0b0;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 10px 20px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mode-btn.active {
            background: rgba(74, 144, 226, 0.3);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .mode-btn:hover {
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-item label {
            color: #b0b0b0;
            font-size: 0.9rem;
            min-width: 60px;
        }

        .control-select, .control-input {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .control-select:focus, .control-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .control-btn {
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid #4a90e2;
            border-radius: 6px;
            padding: 8px 15px;
            color: #4a90e2;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: rgba(74, 144, 226, 0.4);
            color: #fff;
        }

        .file-upload {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 8px 15px;
            color: #00ff88;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .file-upload:hover {
            background: rgba(0, 255, 136, 0.4);
        }

        .view-toggle {
            display: flex;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle button {
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .view-toggle button.active {
            background: #4a90e2;
            color: #fff;
        }

        .loading {
            text-align: center;
            color: #4a90e2;
            padding: 20px;
            font-size: 1.1rem;
        }

        .main-area {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 0;
        }

        .sidebar {
            width: 380px;
            background: rgba(20, 20, 20, 0.9);
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h3 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .info-panel {
            background: rgba(40, 40, 40, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #00ff88;
            max-height: 500px;
            overflow-y: auto;
        }

        .info-panel h4 {
            color: #00ff88;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .info-panel .field {
            margin-bottom: 8px;
        }

        .info-panel .field-label {
            color: #4a90e2;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .info-panel .field-value {
            color: #b0b0b0;
            font-size: 0.8rem;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(40, 40, 40, 0.4);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            margin-top: 2px;
        }

        .content-area {
            flex: 1;
            position: relative;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .graph-container {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(74, 144, 226, 0.1) 0%, transparent 50%);
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .graph-canvas:active {
            cursor: grabbing;
        }

        .table-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 10, 0.5);
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
            padding: 20px;
            min-height: 0;
        }

        .table-controls {
            padding: 15px 20px;
            background: rgba(20, 20, 20, 0.9);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .table-controls .info {
            color: #b0b0b0;
            font-size: 0.9rem;
        }

        .table-controls .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 10px;
            border: 1px solid #333;
            text-align: left;
            font-size: 0.8rem;
            vertical-align: top;
        }

        .data-table th {
            background: rgba(40, 40, 40, 0.9);
            color: #4a90e2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            color: #b0b0b0;
            word-wrap: break-word;
            max-width: 200px;
        }

        .data-table tr:hover {
            background: rgba(74, 144, 226, 0.1);
        }

        .data-table tr.selected {
            background: rgba(74, 144, 226, 0.2);
        }

        .data-table .mandatory {
            color: #ff4757;
            font-weight: bold;
        }

        .data-table .optional {
            color: #7bed9f;
        }

        .data-table .required {
            color: #ff4757;
            font-weight: bold;
        }

        .data-table .cell-content {
            max-height: 60px;
            overflow: hidden;
            line-height: 1.4;
        }

        .data-table .cell-content.expanded {
            max-height: none;
        }

        .expand-btn {
            color: #4a90e2;
            cursor: pointer;
            font-size: 0.7rem;
            margin-top: 2px;
            display: inline-block;
        }

        .expand-btn:hover {
            color: #00ff88;
        }

        .column-toggle {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(40, 40, 40, 0.6);
            border-radius: 6px;
        }

        .column-toggle h4 {
            color: #4a90e2;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .column-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.3);
        }

        .node-circle {
            stroke-width: 2;
            transition: all 0.3s ease;
        }

        .node-text {
            fill: #ffffff;
            font-size: 10px;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            font-weight: 500;
        }

        .link {
            stroke: #555;
            stroke-width: 1;
            fill: none;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .link:hover {
            stroke: #4a90e2;
            opacity: 1;
            stroke-width: 2;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
            max-width: 200px;
        }

        .legend h4 {
            color: #4a90e2;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #555;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #4a90e2;
            border-radius: 6px;
            padding: 10px;
            color: #fff;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .upload-area {
            border: 2px dashed #4a90e2;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
        }

        .error-message {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            border-radius: 6px;
            padding: 15px;
            color: #ff4757;
            margin: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 20, 20, 0.9);
            border-top: 1px solid #333;
        }

        .pagination button {
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px 12px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .pagination button:hover,
        .pagination button.active {
            background: rgba(74, 144, 226, 0.3);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 300px;
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ESGæ•°æ®ä¸€ä½“åŒ–å¯è§†åŒ–ç³»ç»Ÿ</h1>
            <p>é›†æˆESGé—®å·æ•°æ®å’ŒæŠ«éœ²æ ‡å‡†çš„ç»¼åˆåˆ†æå¹³å°</p>
            
            <div class="mode-switcher">
                <div class="mode-btn active" onclick="switchDataMode('questionnaire')">
                    ğŸ“Š ESGé—®å·æ•°æ®
                </div>
                <div class="mode-btn" onclick="switchDataMode('standards')">
                    ğŸ“‹ æŠ«éœ²æ ‡å‡†
                </div>
            </div>

            <div class="controls">
                <!-- é€šç”¨æ§ä»¶ -->
                <div class="control-item">
                    <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv,.jsonl,.json" style="display: none;">
                    <button class="file-upload" onclick="document.getElementById('fileInput').click()">ä¸Šä¼ æ•°æ®æ–‡ä»¶</button>
                </div>

                <!-- é—®å·æ¨¡å¼æ§ä»¶ -->
                <div id="questionnaireControls" class="questionnaire-controls">
                    <div class="control-item">
                        <label>ESGé¢†åŸŸ:</label>
                        <select class="control-select" id="domainSelect">
                            <option value="all">å…¨éƒ¨é¢†åŸŸ</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>ä¸»é¢˜:</label>
                        <select class="control-select" id="topicSelect">
                            <option value="all">å…¨éƒ¨ä¸»é¢˜</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>å¿…å¡«é¡¹:</label>
                        <select class="control-select" id="requiredSelect">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="æ˜¯">å¿…å¡«</option>
                            <option value="å¦">éå¿…å¡«</option>
                        </select>
                    </div>
                </div>

                <!-- æ ‡å‡†æ¨¡å¼æ§ä»¶ -->
                <div id="standardsControls" class="standards-controls hidden">
                    <div class="control-item">
                        <label>æ ‡å‡†:</label>
                        <select class="control-select" id="standardSelect">
                            <option value="all">å…¨éƒ¨æ ‡å‡†</option>
                            <option value="GRI">GRI</option>
                            <option value="SASB">SASB</option>
                            <option value="TCFD">TCFD</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>è¦æ±‚ç±»å‹:</label>
                        <select class="control-select" id="typeSelect">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="mandatory">å¼ºåˆ¶æ€§</option>
                            <option value="optional">å¯é€‰æ€§</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>è¡Œä¸š:</label>
                        <select class="control-select" id="industrySelect">
                            <option value="all">å…¨éƒ¨è¡Œä¸š</option>
                        </select>
                    </div>
                </div>

                <!-- é€šç”¨æ§ä»¶ -->
                <div class="control-item">
                    <label>æœç´¢:</label>
                    <input type="text" class="control-input" id="searchInput" placeholder="æœç´¢å†…å®¹...">
                </div>

                <div class="view-toggle">
                    <button class="active" onclick="switchView('graph')">å›¾è°±è§†å›¾</button>
                    <button onclick="switchView('table')">è¡¨æ ¼è§†å›¾</button>
                </div>

                <button class="control-btn hidden" onclick="resetView()" id="resetBtn">é‡ç½®è§†å›¾</button>
                <button class="control-btn hidden" onclick="exportData()" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
            </div>
        </div>

        <div class="main-area">
            <div id="uploadArea" class="upload-area">
                <h3 style="color: #4a90e2; margin-bottom: 15px;">ä¸Šä¼ æ•°æ®æ–‡ä»¶</h3>
                <div id="uploadInstructions">
                    <p style="color: #b0b0b0; margin-bottom: 15px;">
                        <strong>ESGé—®å·æ¨¡å¼:</strong> æ”¯æŒExcelæ–‡ä»¶(.xlsx, .xls)å’ŒCSVæ–‡ä»¶<br>
                        è¡¨å¤´åº”åŒ…å«ï¼šESGé¢†åŸŸã€ä¸»é¢˜ã€Key Issueã€æŒ‡æ ‡IDã€æŒ‡æ ‡åç§°ç­‰å­—æ®µ
                    </p>
                    <p style="color: #b0b0b0; margin-bottom: 15px;">
                        <strong>æŠ«éœ²æ ‡å‡†æ¨¡å¼:</strong> æ”¯æŒJSONLæ ¼å¼æ–‡ä»¶<br>
                        åŒ…å«ï¼šclause_idã€clause_contentã€mandatory_optionalç­‰å­—æ®µ
                    </p>
                </div>
                <button class="file-upload" onclick="document.getElementById('fileInput').click()">
                    é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„
                </button>
                <p style="color: #888; font-size: 0.8rem; margin-top: 10px;">
                    æ”¯æŒåŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹
                </p>
            </div>
            
            <div class="loading hidden" id="loading">æ­£åœ¨å¤„ç†æ•°æ®...</div>
            
            <div class="sidebar hidden" id="sidebar">
                <h3 id="sidebarTitle">è¯¦ç»†ä¿¡æ¯</h3>
                <div class="info-panel" id="infoPanel">
                    <h4>é€‰æ‹©èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</h4>
                    <p>ç‚¹å‡»å›¾è°±ä¸­çš„ä»»æ„èŠ‚ç‚¹æˆ–è¡¨æ ¼ä¸­çš„è¡Œï¼ŒæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
                </div>

                <h3>æ•°æ®ç»Ÿè®¡</h3>
                <div class="stats-grid" id="statsGrid">
                    <!-- ç»Ÿè®¡ä¿¡æ¯å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="content-area hidden" id="contentArea">
                <div class="graph-container" id="graphContainer">
                    <svg class="graph-canvas" id="graphCanvas"></svg>
                    <div class="legend" id="legend">
                        <!-- å›¾ä¾‹å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="table-container hidden" id="tableContainer">
                    <div class="table-controls" id="tableControls">
                        <div class="info" id="tableInfo">
                            æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡ä¿¡æ¯
                        </div>
                        <div class="controls">
                            <select class="control-select" id="pageSizeSelect" onchange="changePageSize()">
                                <option value="25">25æ¡/é¡µ</option>
                                <option value="50" selected>50æ¡/é¡µ</option>
                                <option value="100">100æ¡/é¡µ</option>
                                <option value="200">200æ¡/é¡µ</option>
                            </select>
                            <button class="control-btn" onclick="toggleColumnSelector()">åˆ—è®¾ç½®</button>
                        </div>
                    </div>
                    
                    <div class="column-toggle hidden" id="columnSelector">
                        <h4>é€‰æ‹©æ˜¾ç¤ºåˆ—</h4>
                        <div class="column-checkboxes" id="columnCheckboxes">
                            <!-- åˆ—é€‰æ‹©å™¨å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="table-wrapper" id="tableWrapper">
                        <div id="tableContent">
                            <!-- è¡¨æ ¼å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="pagination" id="pagination">
                        <!-- åˆ†é¡µå°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentDataMode = 'questionnaire'; // 'questionnaire' æˆ– 'standards'
        let currentView = 'graph'; // 'graph' æˆ– 'table'
        let allData = [];
        let filteredData = [];
        let svg, g, simulation;
        let selectedNode = null;
        let currentPage = 1;
        let itemsPerPage = 50;

        // é—®å·è¡¨æ ¼åˆ—é…ç½®
        let questionnaireColumns = {
            'indicatorId': { label: 'æŒ‡æ ‡ID', visible: true, width: '120px' },
            'indicatorName': { label: 'æŒ‡æ ‡åç§°', visible: true, width: '200px' },
            'esgDomain': { label: 'ESGé¢†åŸŸ', visible: true, width: '100px' },
            'topic': { label: 'ä¸»é¢˜', visible: true, width: '120px' },
            'keyIssue': { label: 'å…³é”®è®®é¢˜', visible: true, width: '150px' },
            'description': { label: 'æŒ‡æ ‡æè¿°', visible: true, width: '250px' },
            'calculation': { label: 'è®¡ç®—æ–¹æ³•', visible: true, width: '200px' },
            'dataCollection': { label: 'æ•°æ®æ”¶é›†æŒ‡å¯¼', visible: true, width: '200px' },
            'dataType': { label: 'æ•°æ®ç±»å‹', visible: true, width: '100px' },
            'unit': { label: 'å»ºè®®å•ä½', visible: true, width: '100px' },
            'required': { label: 'æ˜¯å¦å¿…å¡«', visible: true, width: '80px' },
            'reference': { label: 'å‚è€ƒæ ‡å‡†', visible: true, width: '150px' },
            'notes': { label: 'æŠ«éœ²æ³¨æ„äº‹é¡¹', visible: true, width: '200px' },
            'actualData': { label: 'å®é™…æŠ«éœ²æ•°æ®', visible: true, width: '150px' },
            'reliability': { label: 'æ•°æ®å¯ä¿¡åº¦', visible: true, width: '100px' },
            'sampleData': { label: 'å‡æ•°æ®', visible: false, width: '150px' },
            'dataDescription': { label: 'æ•°æ®è¯´æ˜', visible: false, width: '200px' },
            'dataRemarks': { label: 'æ•°æ®å¤‡æ³¨', visible: false, width: '200px' },
            'sourceBatch': { label: 'æ¥æºæ‰¹æ¬¡', visible: false, width: '100px' },
            'relatedClauseId': { label: 'ç›¸å…³æ¡æ¬¾ID', visible: false, width: '150px' },
            'finalRemarks': { label: 'æœ€ç»ˆå¤‡æ³¨', visible: false, width: '200px' }
        };

        // æ ‡å‡†è¡¨æ ¼åˆ—é…ç½®
        let standardsColumns = {
            'clause_id': { label: 'æ¡æ¬¾ID', visible: true, width: '120px' },
            'clause_content': { label: 'æ¡æ¬¾å†…å®¹', visible: true, width: '300px' },
            'standard': { label: 'æ ‡å‡†', visible: true, width: '80px' },
            'mandatory_optional': { label: 'ç±»å‹', visible: true, width: '80px' },
            'applicable_industry': { label: 'é€‚ç”¨è¡Œä¸š', visible: true, width: '120px' },
            'related_topics': { label: 'ç›¸å…³ä¸»é¢˜', visible: true, width: '200px' },
            'related_clauses': { label: 'ç›¸å…³æ¡æ¬¾', visible: true, width: '150px' },
            'original_text': { label: 'åŸå§‹æ–‡æœ¬', visible: false, width: '300px' },
            'auto_clause_number': { label: 'è‡ªåŠ¨ç¼–å·', visible: false, width: '120px' }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateUIForMode();
        });

        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);

            // ç­›é€‰å™¨
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        // åˆ‡æ¢æ•°æ®æ¨¡å¼
        function switchDataMode(mode) {
            currentDataMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°ç•Œé¢
            updateUIForMode();
            
            // æ¸…ç©ºæ•°æ®
            allData = [];
            filteredData = [];
            resetInterface();
        }

        function updateUIForMode() {
            const questionnaireControls = document.getElementById('questionnaireControls');
            const standardsControls = document.getElementById('standardsControls');

            if (currentDataMode === 'questionnaire') {
                questionnaireControls.classList.remove('hidden');
                standardsControls.classList.add('hidden');
                document.getElementById('searchInput').placeholder = 'æœç´¢æŒ‡æ ‡åç§°...';
            } else {
                questionnaireControls.classList.add('hidden');
                standardsControls.classList.remove('hidden');
                document.getElementById('searchInput').placeholder = 'æœç´¢æ¡æ¬¾å†…å®¹...';
            }
        }

        function resetInterface() {
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('contentArea').classList.add('hidden');
            document.getElementById('resetBtn').classList.add('hidden');
            document.getElementById('exportBtn').classList.add('hidden');
        }

        // å¤„ç†æ–‡ä»¶
        async function processFiles(files) {
            if (files.length === 0) return;

            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loading').textContent = `æ­£åœ¨å¤„ç† ${files.length} ä¸ªæ–‡ä»¶...`;

            allData = [];

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    document.getElementById('loading').textContent = `æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i + 1}/${files.length}: ${file.name}`;
                    
                    if (currentDataMode === 'questionnaire') {
                        await processQuestionnaireFile(file);
                    } else {
                        await processStandardsFile(file);
                    }
                }

                if (allData.length === 0) {
                    throw new Error('æ²¡æœ‰æˆåŠŸè§£æåˆ°ä»»ä½•æ•°æ®');
                }

                document.getElementById('loading').textContent = `æˆåŠŸåŠ è½½ ${allData.length} æ¡æ•°æ®ï¼Œæ­£åœ¨ç”Ÿæˆå¯è§†åŒ–...`;
                
                // åˆå§‹åŒ–ç•Œé¢
                initializeInterface();
                setupModeFilters();
                applyFilters();
                
                // æ˜¾ç¤ºç•Œé¢
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                document.getElementById('resetBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                
                if (currentView === 'graph') {
                    document.getElementById('graphContainer').classList.remove('hidden');
                    document.getElementById('tableContainer').classList.add('hidden');
                    initGraph();
                } else {
                    document.getElementById('graphContainer').classList.add('hidden');
                    document.getElementById('tableContainer').classList.remove('hidden');
                    generateTable();
                }
                
            } catch (error) {
                console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error-message">
                        <h3>æ–‡ä»¶å¤„ç†å¤±è´¥</h3>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <p>è¯·ç¡®ä¿ä¸Šä¼ çš„æ–‡ä»¶æ ¼å¼æ­£ç¡®</p>
                        <button class="control-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
            }
        }

        // å¤„ç†é—®å·æ–‡ä»¶
        async function processQuestionnaireFile(file) {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            const processedData = jsonData.map((row, index) => ({
                id: index + 1,
                type: 'questionnaire',
                esgDomain: row['ESGé¢†åŸŸ'] || row['ESG_Domain'] || '',
                topic: row['ä¸»é¢˜'] || row['Topic'] || '',
                keyIssue: row['Key Issue'] || row['å…³é”®è®®é¢˜'] || '',
                indicatorId: row['æŒ‡æ ‡ID'] || row['Indicator_ID'] || '',
                indicatorName: row['æŒ‡æ ‡åç§°'] || row['Indicator_Name'] || '',
                description: row['æŒ‡æ ‡æè¿°'] || row['Description'] || '',
                calculation: row['è®¡ç®—æ–¹æ³•'] || row['Calculation'] || '',
                dataCollection: row['æ•°æ®æ”¶é›†æŒ‡å¯¼'] || row['Data_Collection'] || '',
                dataType: row['æ•°æ®ç±»å‹'] || row['Data_Type'] || '',
                unit: row['å»ºè®®å•ä½'] || row['Unit'] || '',
                required: row['æ˜¯å¦å¿…å¡«'] || row['Required'] || '',
                reference: row['å‚è€ƒæ ‡å‡†'] || row['Reference'] || '',
                notes: row['æŠ«éœ²æ³¨æ„äº‹é¡¹'] || row['Notes'] || '',
                sampleData: row['å‡æ•°æ®'] || row['Sample_Data'] || '',
                dataDescription: row['æ•°æ®è¯´æ˜'] || row['Data_Description'] || '',
                dataRemarks: row['æ•°æ®å¤‡æ³¨'] || row['Data_Remarks'] || '',
                reliability: row['æ•°æ®å¯ä¿¡åº¦'] || row['Reliability'] || '',
                sourceBatch: row['æ¥æºæ‰¹æ¬¡'] || row['Source_Batch'] || '',
                relatedClauseId: row['ç›¸å…³æ¡æ¬¾ID'] || row['Related_Clause_ID'] || '',
                actualData: row['å®é™…æŠ«éœ²æ•°æ®'] || row['Actual_Data'] || '',
                finalRemarks: row['æœ€ç»ˆå¤‡æ³¨'] || row['Final_Remarks'] || ''
            }));

            allData.push(...processedData);
        }

        // å¤„ç†æ ‡å‡†æ–‡ä»¶
        async function processStandardsFile(file) {
            const text = await readFileAsText(file);
            const lines = text.split('\n').filter(line => line.trim());
            
            // ç¡®å®šæ ‡å‡†ç±»å‹
            let standard = 'UNKNOWN';
            if (file.name.includes('GRI')) standard = 'GRI';
            else if (file.name.includes('SASB')) standard = 'SASB';
            else if (file.name.includes('TCFD')) standard = 'TCFD';

            const processedData = [];
            for (const line of lines) {
                try {
                    const item = JSON.parse(line);
                    processedData.push({
                        ...item,
                        type: 'standards',
                        standard: item.standard || item.applicable_standard || standard
                    });
                } catch (parseError) {
                    console.warn('è§£æè¡Œå¤±è´¥:', line, parseError);
                }
            }

            allData.push(...processedData);
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // åˆå§‹åŒ–ç•Œé¢
        function initializeInterface() {
            if (currentDataMode === 'questionnaire') {
                initQuestionnaireInterface();
            } else {
                initStandardsInterface();
            }
            updateStats();
            setupColumnSelector();
        }

        function initQuestionnaireInterface() {
            // å¡«å……ESGé¢†åŸŸé€‰æ‹©å™¨
            const domains = [...new Set(allData.map(d => d.esgDomain))].filter(d => d);
            const domainSelect = document.getElementById('domainSelect');
            domainSelect.innerHTML = '<option value="all">å…¨éƒ¨é¢†åŸŸ</option>';
            domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainSelect.appendChild(option);
            });

            // å¡«å……ä¸»é¢˜é€‰æ‹©å™¨
            const topics = [...new Set(allData.map(d => d.topic))].filter(d => d);
            const topicSelect = document.getElementById('topicSelect');
            topicSelect.innerHTML = '<option value="all">å…¨éƒ¨ä¸»é¢˜</option>';
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });

            document.getElementById('sidebarTitle').textContent = 'æŒ‡æ ‡è¯¦æƒ…';
        }

        function initStandardsInterface() {
            // å¡«å……è¡Œä¸šé€‰æ‹©å™¨
            const industries = [...new Set(allData.map(d => d.applicable_industry))].filter(d => d);
            const industrySelect = document.getElementById('industrySelect');
            industrySelect.innerHTML = '<option value="all">å…¨éƒ¨è¡Œä¸š</option>';
            industries.forEach(industry => {
                if (industry && industry !== 'general') {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    industrySelect.appendChild(option);
                }
            });

            // å¡«å……æ ‡å‡†é€‰æ‹©å™¨
            const standards = [...new Set(allData.map(d => d.standard))].filter(d => d);
            const standardSelect = document.getElementById('standardSelect');
            standardSelect.innerHTML = '<option value="all">å…¨éƒ¨æ ‡å‡†</option>';
            standards.forEach(standard => {
                const option = document.createElement('option');
                option.value = standard;
                option.textContent = standard;
                standardSelect.appendChild(option);
            });

            document.getElementById('sidebarTitle').textContent = 'æ¡æ¬¾è¯¦æƒ…';
        }

        function setupModeFilters() {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const selects = document.querySelectorAll('.control-select');
            selects.forEach(select => {
                select.removeEventListener('change', applyFilters);
                select.addEventListener('change', applyFilters);
            });
        }

        // è®¾ç½®åˆ—é€‰æ‹©å™¨
        function setupColumnSelector() {
            const columns = currentDataMode === 'questionnaire' ? questionnaireColumns : standardsColumns;
            const container = document.getElementById('columnCheckboxes');
            
            container.innerHTML = '';
            Object.keys(columns).forEach(key => {
                const div = document.createElement('div');
                div.className = 'column-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="col_${key}" ${columns[key].visible ? 'checked' : ''} 
                           onchange="toggleColumn('${key}')">
                    <label for="col_${key}">${columns[key].label}</label>
                `;
                container.appendChild(div);
            });
        }

        function toggleColumn(columnKey) {
            const columns = currentDataMode === 'questionnaire' ? questionnaireColumns : standardsColumns;
            columns[columnKey].visible = !columns[columnKey].visible;
            generateTable();
        }

        function toggleColumnSelector() {
            const selector = document.getElementById('columnSelector');
            selector.classList.toggle('hidden');
        }

        function changePageSize() {
            itemsPerPage = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            generateTable();
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();

            if (currentDataMode === 'questionnaire') {
                applyQuestionnaireFilters(search);
            } else {
                applyStandardsFilters(search);
            }

            updateStats();
            currentPage = 1; // é‡ç½®é¡µç 

            if (currentView === 'graph' && svg) {
                updateGraph();
            } else if (currentView === 'table') {
                generateTable();
            }
        }

        function applyQuestionnaireFilters(search) {
            const domain = document.getElementById('domainSelect').value;
            const topic = document.getElementById('topicSelect').value;
            const required = document.getElementById('requiredSelect').value;

            filteredData = allData.filter(item => {
                if (domain !== 'all' && item.esgDomain !== domain) return false;
                if (topic !== 'all' && item.topic !== topic) return false;
                if (required !== 'all' && item.required !== required) return false;
                if (search && !item.indicatorName.toLowerCase().includes(search) && 
                    !item.description.toLowerCase().includes(search)) return false;
                return true;
            });
        }

        function applyStandardsFilters(search) {
            const standard = document.getElementById('standardSelect').value;
            const type = document.getElementById('typeSelect').value;
            const industry = document.getElementById('industrySelect').value;

            filteredData = allData.filter(item => {
                if (standard !== 'all' && item.standard !== standard) return false;
                if (type !== 'all' && item.mandatory_optional !== type) return false;
                if (industry !== 'all' && item.applicable_industry !== industry) return false;
                if (search && !item.clause_content.toLowerCase().includes(search) && 
                    !item.original_text.toLowerCase().includes(search)) return false;
                return true;
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            if (currentDataMode === 'questionnaire') {
                updateQuestionnaireStats(statsGrid);
            } else {
                updateStandardsStats(statsGrid);
            }
        }

        function updateQuestionnaireStats(statsGrid) {
            const requiredCount = filteredData.filter(d => d.required === 'æ˜¯').length;
            const domains = new Set(filteredData.map(d => d.esgDomain).filter(d => d));
            const types = new Set(filteredData.map(d => d.dataType).filter(d => d));
            const withData = filteredData.filter(d => d.actualData && d.actualData.trim()).length;
            const completionRate = filteredData.length > 0 ? Math.round((withData / filteredData.length) * 100) : 0;
            const reliabilityValues = filteredData.map(d => parseFloat(d.reliability)).filter(v => !isNaN(v));
            const avgReliability = reliabilityValues.length > 0 ? 
                (reliabilityValues.reduce((a, b) => a + b, 0) / reliabilityValues.length).toFixed(1) : 0;

            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${filteredData.length}</div>
                    <div class="stat-label">æŒ‡æ ‡æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${requiredCount}</div>
                    <div class="stat-label">å¿…å¡«æŒ‡æ ‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${domains.size}</div>
                    <div class="stat-label">ESGé¢†åŸŸ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${types.size}</div>
                    <div class="stat-label">æ•°æ®ç±»å‹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${completionRate}%</div>
                    <div class="stat-label">å¡«æŠ¥ç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${avgReliability}</div>
                    <div class="stat-label">å¹³å‡å¯ä¿¡åº¦</div>
                </div>
            `;
        }

        function updateStandardsStats(statsGrid) {
            const mandatoryCount = filteredData.filter(d => d.mandatory_optional === 'mandatory').length;
            const optionalCount = filteredData.filter(d => d.mandatory_optional === 'optional').length;
            const standards = new Set(filteredData.map(d => d.standard).filter(d => d));
            const topics = new Set();
            filteredData.forEach(d => {
                if (d.related_topics) {
                    d.related_topics.split(',').forEach(topic => topics.add(topic.trim()));
                }
            });

            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${filteredData.length}</div>
                    <div class="stat-label">æ¡æ¬¾æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${mandatoryCount}</div>
                    <div class="stat-label">å¼ºåˆ¶æ€§</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${optionalCount}</div>
                    <div class="stat-label">å¯é€‰æ€§</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${standards.size}</div>
                    <div class="stat-label">æ ‡å‡†æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${topics.size}</div>
                    <div class="stat-label">ä¸»é¢˜æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${Math.round((mandatoryCount / Math.max(filteredData.length, 1)) * 100)}%</div>
                    <div class="stat-label">å¼ºåˆ¶æ€§æ¯”ä¾‹</div>
                </div>
            `;
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'graph') {
                document.getElementById('graphContainer').classList.remove('hidden');
                document.getElementById('tableContainer').classList.add('hidden');
                if (allData.length > 0 && !svg) {
                    initGraph();
                } else if (svg) {
                    updateGraph();
                }
            } else {
                document.getElementById('graphContainer').classList.add('hidden');
                document.getElementById('tableContainer').classList.remove('hidden');
                generateTable();
            }
        }

        // ç”Ÿæˆå›¾è°±æ•°æ®
        function generateGraphData() {
            if (currentDataMode === 'questionnaire') {
                return generateQuestionnaireGraphData();
            } else {
                return generateStandardsGraphData();
            }
        }

        function generateQuestionnaireGraphData() {
            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // åˆ›å»ºESGé¢†åŸŸèŠ‚ç‚¹
            const domains = [...new Set(filteredData.map(d => d.esgDomain))].filter(d => d);
            domains.forEach(domain => {
                const node = { id: `domain_${domain}`, name: domain, type: 'esg-domain', group: 'domain' };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // åˆ›å»ºä¸»é¢˜èŠ‚ç‚¹
            const topics = [...new Set(filteredData.map(d => d.topic))].filter(d => d);
            topics.forEach(topic => {
                const node = {
                    id: `topic_${topic}`,
                    name: topic.length > 12 ? topic.substring(0, 10) + '...' : topic,
                    fullName: topic,
                    type: 'topic',
                    group: 'topic'
                };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // é‡‡æ ·æŒ‡æ ‡
            let indicatorsToShow = filteredData;
            if (filteredData.length > 150) {
                indicatorsToShow = filteredData.sort(() => 0.5 - Math.random()).slice(0, 150);
            }

            // åˆ›å»ºæŒ‡æ ‡èŠ‚ç‚¹
            indicatorsToShow.forEach(indicator => {
                const indicatorNode = {
                    id: `indicator_${indicator.indicatorId}`,
                    name: indicator.indicatorId,
                    fullName: indicator.indicatorName,
                    type: indicator.required === 'æ˜¯' ? 'required' : 'optional',
                    group: 'indicator',
                    data: indicator
                };
                nodes.push(indicatorNode);
                nodeMap.set(indicatorNode.id, indicatorNode);

                // å»ºç«‹è¿æ¥
                if (indicator.esgDomain) {
                    const domainId = `domain_${indicator.esgDomain}`;
                    if (nodeMap.has(domainId)) {
                        links.push({ source: domainId, target: indicatorNode.id, type: 'domain_indicator' });
                    }
                }

                if (indicator.topic) {
                    const topicId = `topic_${indicator.topic}`;
                    if (nodeMap.has(topicId)) {
                        links.push({ source: topicId, target: indicatorNode.id, type: 'topic_indicator' });
                    }
                }
            });

            return { nodes, links };
        }

        function generateStandardsGraphData() {
            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // åˆ›å»ºæ ‡å‡†èŠ‚ç‚¹
            const standards = [...new Set(filteredData.map(d => d.standard))].filter(d => d);
            standards.forEach(standard => {
                const node = { id: `standard_${standard}`, name: standard, type: 'standard', group: standard };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // åˆ›å»ºä¸»é¢˜èŠ‚ç‚¹
            const topics = new Set();
            filteredData.forEach(d => {
                if (d.related_topics) {
                    d.related_topics.split(',').forEach(topic => {
                        const trimmedTopic = topic.trim();
                        if (trimmedTopic && trimmedTopic.length > 1) topics.add(trimmedTopic);
                    });
                }
            });

            // åªä¿ç•™é¢‘ç¹å‡ºç°çš„ä¸»é¢˜
            const topicFreq = new Map();
            filteredData.forEach(d => {
                if (d.related_topics) {
                    d.related_topics.split(',').forEach(topic => {
                        const trimmedTopic = topic.trim();
                        if (trimmedTopic && trimmedTopic.length > 1) {
                            topicFreq.set(trimmedTopic, (topicFreq.get(trimmedTopic) || 0) + 1);
                        }
                    });
                }
            });

            const frequentTopics = Array.from(topicFreq.entries())
                .filter(([topic, freq]) => freq > 1)
                .map(([topic, freq]) => topic);

            frequentTopics.forEach(topic => {
                const node = {
                    id: `topic_${topic}`,
                    name: topic.length > 15 ? topic.substring(0, 12) + '...' : topic,
                    fullName: topic,
                    type: 'topic',
                    group: 'topic'
                };
                nodes.push(node);
                nodeMap.set(node.id, node);
            });

            // é‡‡æ ·æ¡æ¬¾
            let clausesToShow = filteredData;
            if (filteredData.length > 200) {
                clausesToShow = filteredData.sort(() => 0.5 - Math.random()).slice(0, 200);
            }

            // åˆ›å»ºæ¡æ¬¾èŠ‚ç‚¹
            clausesToShow.forEach(clause => {
                const clauseNode = {
                    id: `clause_${clause.clause_id}`,
                    name: clause.clause_id,
                    type: clause.mandatory_optional || 'unknown',
                    group: clause.standard,
                    data: clause
                };
                nodes.push(clauseNode);
                nodeMap.set(clauseNode.id, clauseNode);

                // å»ºç«‹è¿æ¥
                const standardId = `standard_${clause.standard}`;
                if (nodeMap.has(standardId)) {
                    links.push({ source: standardId, target: clauseNode.id, type: 'standard_clause' });
                }

                if (clause.related_topics) {
                    clause.related_topics.split(',').forEach(topic => {
                        const trimmedTopic = topic.trim();
                        if (frequentTopics.includes(trimmedTopic)) {
                            const topicId = `topic_${trimmedTopic}`;
                            if (nodeMap.has(topicId)) {
                                links.push({ source: topicId, target: clauseNode.id, type: 'topic_clause' });
                            }
                        }
                    });
                }
            });

            return { nodes, links };
        }

        // åˆå§‹åŒ–å›¾è°±
        function initGraph() {
            const container = document.getElementById('graphCanvas');
            const rect = container.getBoundingClientRect();
            
            svg = d3.select('#graphCanvas')
                .attr('width', rect.width)
                .attr('height', rect.height);

            g = svg.append('g');

            // æ·»åŠ ç¼©æ”¾å’Œæ‹–æ‹½
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // åˆ›å»ºåŠ›å¯¼å‘å¸ƒå±€
            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(rect.width / 2, rect.height / 2))
                .force('collision', d3.forceCollide().radius(20));

            updateGraph();
            updateLegend();
        }

        // æ›´æ–°å›¾è°±
        function updateGraph() {
            if (!svg) return;

            const graphData = generateGraphData();
            const { nodes, links } = graphData;

            // æ¸…ç©ºç°æœ‰å†…å®¹
            g.selectAll('*').remove();

            // ç»˜åˆ¶è¿çº¿
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .style('stroke', d => {
                    switch(d.type) {
                        case 'domain_indicator': return '#00ff88';
                        case 'topic_indicator': return '#ff6b6b';
                        case 'standard_clause': return '#4a90e2';
                        case 'topic_clause': return '#ff6b6b';
                        default: return '#555';
                    }
                })
                .style('stroke-width', 2)
                .style('opacity', 0.6);

            // ç»˜åˆ¶èŠ‚ç‚¹
            const node = g.append('g')
                .selectAll('.node')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('click', selectNode)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            // èŠ‚ç‚¹åœ†åœˆ
            node.append('circle')
                .attr('class', d => `node-circle ${d.type}`)
                .attr('r', d => {
                    switch(d.type) {
                        case 'esg-domain': case 'standard': return 25;
                        case 'topic': return 18;
                        case 'key-issue': return 15;
                        case 'required': case 'mandatory': return 8;
                        case 'optional': return 8;
                        default: return 10;
                    }
                })
                .style('fill', d => getNodeColor(d.type))
                .style('stroke', '#4a90e2')
                .style('stroke-width', 2);

            // èŠ‚ç‚¹æ–‡å­—
            node.append('text')
                .attr('class', 'node-text')
                .text(d => {
                    if (d.type === 'required' || d.type === 'optional' || d.type === 'mandatory') {
                        return '';
                    }
                    return d.name;
                })
                .style('fill', '#ffffff')
                .style('font-size', d => d.type === 'esg-domain' || d.type === 'standard' ? '12px' : '10px')
                .style('text-anchor', 'middle')
                .style('dominant-baseline', 'central')
                .style('pointer-events', 'none');

            // æ›´æ–°åŠ›å¯¼å‘å¸ƒå±€
            simulation.nodes(nodes);
            simulation.force('link').links(links);
            simulation.alpha(1).restart();

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function getNodeColor(type) {
            const colors = {
                'esg-domain': '#00ff88',
                'standard': '#00ff88',
                'topic': '#ff6b6b',
                'key-issue': '#ffd93d',
                'required': '#ff4757',
                'mandatory': '#ff4757',
                'optional': '#7bed9f'
            };
            return colors[type] || '#4a90e2';
        }

        function updateLegend() {
            const legend = document.getElementById('legend');
            
            if (currentDataMode === 'questionnaire') {
                legend.innerHTML = `
                    <h4>èŠ‚ç‚¹ç±»å‹</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff88;"></div>
                        <span>ESGé¢†åŸŸ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>ä¸»é¢˜</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4757;"></div>
                        <span>å¿…å¡«æŒ‡æ ‡</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #7bed9f;"></div>
                        <span>å¯é€‰æŒ‡æ ‡</span>
                    </div>
                `;
            } else {
                legend.innerHTML = `
                    <h4>èŠ‚ç‚¹ç±»å‹</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff88;"></div>
                        <span>æŠ«éœ²æ ‡å‡†</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>ç›¸å…³ä¸»é¢˜</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4757;"></div>
                        <span>å¼ºåˆ¶æ€§æ¡æ¬¾</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #7bed9f;"></div>
                        <span>å¯é€‰æ€§æ¡æ¬¾</span>
                    </div>
                `;
            }
        }

        // ç”Ÿæˆè¡¨æ ¼
        function generateTable() {
            const totalItems = filteredData.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageData = filteredData.slice(startIndex, endIndex);

            // æ›´æ–°è¡¨æ ¼ä¿¡æ¯
            document.getElementById('tableInfo').textContent = 
                `æ˜¾ç¤ºç¬¬ ${startIndex + 1} - ${endIndex} æ¡ï¼Œå…± ${totalItems} æ¡æ•°æ®`;

            let tableHTML = '';

            if (currentDataMode === 'questionnaire') {
                tableHTML = generateQuestionnaireTable(pageData);
            } else {
                tableHTML = generateStandardsTable(pageData);
            }

            document.getElementById('tableContent').innerHTML = tableHTML;

            // ç”Ÿæˆåˆ†é¡µ
            generatePagination(currentPage, totalPages, totalItems);

            // æ·»åŠ è¡Œç‚¹å‡»äº‹ä»¶
            const rows = document.querySelectorAll('.data-table tbody tr');
            rows.forEach((row, index) => {
                row.addEventListener('click', () => {
                    rows.forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    updateInfoPanel(pageData[index]);
                });
            });
        }

        function generateQuestionnaireTable(data) {
            const visibleColumns = Object.keys(questionnaireColumns).filter(key => questionnaireColumns[key].visible);
            
            let html = `<table class="data-table"><thead><tr>`;
            
            // ç”Ÿæˆè¡¨å¤´
            visibleColumns.forEach(key => {
                html += `<th style="min-width: ${questionnaireColumns[key].width}">${questionnaireColumns[key].label}</th>`;
            });
            html += '</tr></thead><tbody>';

            // ç”Ÿæˆæ•°æ®è¡Œ
            data.forEach(item => {
                html += '<tr>';
                visibleColumns.forEach(key => {
                    let value = item[key] || '';
                    let cellClass = '';
                    let cellContent = '';

                    // ç‰¹æ®Šå¤„ç†æŸäº›å­—æ®µ
                    if (key === 'required') {
                        cellClass = value === 'æ˜¯' ? 'required' : '';
                    }

                    // å¤„ç†é•¿æ–‡æœ¬å­—æ®µ
                    if (['description', 'calculation', 'dataCollection', 'notes'].includes(key) && value.length > 100) {
                        const shortText = value.substring(0, 100) + '...';
                        cellContent = `
                            <div class="cell-content" id="cell_${item.id}_${key}">
                                ${shortText}
                            </div>
                            <span class="expand-btn" onclick="toggleCellExpansion('${item.id}', '${key}', \`${value.replace(/`/g, '\\`')}\`)">
                                å±•å¼€
                            </span>
                        `;
                    } else {
                        cellContent = value;
                    }

                    html += `<td class="${cellClass}" title="${value}">${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function generateStandardsTable(data) {
            const visibleColumns = Object.keys(standardsColumns).filter(key => standardsColumns[key].visible);
            
            let html = `<table class="data-table"><thead><tr>`;
            
            // ç”Ÿæˆè¡¨å¤´
            visibleColumns.forEach(key => {
                html += `<th style="min-width: ${standardsColumns[key].width}">${standardsColumns[key].label}</th>`;
            });
            html += '</tr></thead><tbody>';

            // ç”Ÿæˆæ•°æ®è¡Œ
            data.forEach(item => {
                html += '<tr>';
                visibleColumns.forEach(key => {
                    let value = item[key] || '';
                    let cellClass = '';
                    let cellContent = '';

                    // ç‰¹æ®Šå¤„ç†æŸäº›å­—æ®µ
                    if (key === 'mandatory_optional') {
                        cellClass = value;
                        value = value === 'mandatory' ? 'å¼ºåˆ¶æ€§' : 'å¯é€‰æ€§';
                    }

                    // å¤„ç†é•¿æ–‡æœ¬å­—æ®µ
                    if (['clause_content', 'original_text'].includes(key) && value.length > 150) {
                        const shortText = value.substring(0, 150) + '...';
                        cellContent = `
                            <div class="cell-content" id="cell_${item.clause_id}_${key}">
                                ${shortText}
                            </div>
                            <span class="expand-btn" onclick="toggleCellExpansion('${item.clause_id}', '${key}', \`${value.replace(/`/g, '\\`')}\`)">
                                å±•å¼€
                            </span>
                        `;
                    } else {
                        cellContent = value;
                    }

                    html += `<td class="${cellClass}" title="${value}">${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function toggleCellExpansion(id, key, fullText) {
            const cell = document.getElementById(`cell_${id}_${key}`);
            const expandBtn = cell.nextElementSibling;
            
            if (cell.classList.contains('expanded')) {
                // æ”¶èµ·
                const shortText = fullText.substring(0, currentDataMode === 'questionnaire' ? 100 : 150) + '...';
                cell.innerHTML = shortText;
                cell.classList.remove('expanded');
                expandBtn.textContent = 'å±•å¼€';
            } else {
                // å±•å¼€
                cell.innerHTML = fullText;
                cell.classList.add('expanded');
                expandBtn.textContent = 'æ”¶èµ·';
            }
        }

        function generatePagination(current, total, totalItems) {
            const pagination = document.getElementById('pagination');
            let html = '';

            if (current > 1) {
                html += `<button onclick="changePage(${current - 1})">ä¸Šä¸€é¡µ</button>`;
            }

            const startPage = Math.max(1, current - 2);
            const endPage = Math.min(total, current + 2);

            if (startPage > 1) {
                html += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<button disabled>...</button>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === current ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < total) {
                if (endPage < total - 1) {
                    html += `<button disabled>...</button>`;
                }
                html += `<button onclick="changePage(${total})">${total}</button>`;
            }

            if (current < total) {
                html += `<button onclick="changePage(${current + 1})">ä¸‹ä¸€é¡µ</button>`;
            }

            pagination.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            generateTable();
        }

        // é€‰æ‹©èŠ‚ç‚¹/æ›´æ–°ä¿¡æ¯é¢æ¿
        function selectNode(event, d) {
            selectedNode = d;
            
            // é«˜äº®é€‰ä¸­èŠ‚ç‚¹
            g.selectAll('.node-circle').style('stroke-width', 2);
            d3.select(event.currentTarget).select('.node-circle').style('stroke-width', 4);

            updateInfoPanel(d.data || d);
        }

        function updateInfoPanel(data) {
            const infoPanel = document.getElementById('infoPanel');
            
            if (currentDataMode === 'questionnaire') {
                updateQuestionnaireInfo(infoPanel, data);
            } else {
                updateStandardsInfo(infoPanel, data);
            }
        }

        function updateQuestionnaireInfo(panel, data) {
            if (data.indicatorId) {
                // æŒ‡æ ‡æ•°æ®
                panel.innerHTML = `
                    <h4>${data.indicatorName}</h4>
                    <div class="field">
                        <div class="field-label">æŒ‡æ ‡ID:</div>
                        <div class="field-value">${data.indicatorId}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">ESGé¢†åŸŸ:</div>
                        <div class="field-value">${data.esgDomain}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">ä¸»é¢˜:</div>
                        <div class="field-value">${data.topic}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">å…³é”®è®®é¢˜:</div>
                        <div class="field-value">${data.keyIssue}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">æŒ‡æ ‡æè¿°:</div>
                        <div class="field-value">${data.description}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">è®¡ç®—æ–¹æ³•:</div>
                        <div class="field-value">${data.calculation}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">æ•°æ®æ”¶é›†æŒ‡å¯¼:</div>
                        <div class="field-value">${data.dataCollection}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">æ•°æ®ç±»å‹:</div>
                        <div class="field-value">${data.dataType}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">æ˜¯å¦å¿…å¡«:</div>
                        <div class="field-value" style="color: ${data.required === 'æ˜¯' ? '#ff4757' : '#7bed9f'}">${data.required}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">å»ºè®®å•ä½:</div>
                        <div class="field-value">${data.unit}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">å‚è€ƒæ ‡å‡†:</div>
                        <div class="field-value">${data.reference}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">æŠ«éœ²æ³¨æ„äº‹é¡¹:</div>
                        <div class="field-value">${data.notes}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">å®é™…æŠ«éœ²æ•°æ®:</div>
                        <div class="field-value" style="color: ${data.actualData ? '#00ff88' : '#ff4757'}">${data.actualData || 'æœªå¡«æŠ¥'}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">æ•°æ®å¯ä¿¡åº¦:</div>
                        <div class="field-value">${data.reliability}</div>
                    </div>
                `;
            } else {
                // åˆ†ç±»èŠ‚ç‚¹
                panel.innerHTML = `
                    <h4>${data.fullName || data.name}</h4>
                    <div class="field">
                        <div class="field-label">ç±»å‹:</div>
                        <div class="field-value">${data.type === 'esg-domain' ? 'ESGé¢†åŸŸ' : 'ä¸»é¢˜'}</div>
                    </div>
                `;
            }
        }

        function updateStandardsInfo(panel, data) {
            if (data.clause_id) {
                // æ¡æ¬¾æ•°æ®
                panel.innerHTML = `
                    <h4>${data.clause_id}</h4>
                    <div class="field">
                        <div class="field-label">æ¡æ¬¾å†…å®¹:</div>
                        <div class="field-value">${data.clause_content}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">åŸå§‹æ–‡æœ¬:</div>
                        <div class="field-value">${data.original_text}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">ç±»å‹:</div>
                        <div class="field-value">${data.mandatory_optional === 'mandatory' ? 'å¼ºåˆ¶æ€§' : 'å¯é€‰æ€§'}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">é€‚ç”¨æ ‡å‡†:</div>
                        <div class="field-value">${data.standard}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">é€‚ç”¨è¡Œä¸š:</div>
                        <div class="field-value">${data.applicable_industry}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">ç›¸å…³ä¸»é¢˜:</div>
                        <div class="field-value">${data.related_topics || 'æ— '}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">ç›¸å…³æ¡æ¬¾:</div>
                        <div class="field-value">${data.related_clauses || 'æ— '}</div>
                    </div>
                    <div class="field">
                        <div class="field-label">è‡ªåŠ¨ç¼–å·:</div>
                        <div class="field-value">${data.auto_clause_number}</div>
                    </div>
                `;
            } else {
                // åˆ†ç±»èŠ‚ç‚¹
                panel.innerHTML = `
                    <h4>${data.fullName || data.name}</h4>
                    <div class="field">
                        <div class="field-label">ç±»å‹:</div>
                        <div class="field-value">${data.type === 'standard' ? 'æŠ«éœ²æ ‡å‡†' : 'ç›¸å…³ä¸»é¢˜'}</div>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            let content = `<strong>${d.fullName || d.name}</strong><br>ç±»å‹: ${d.type}`;
            
            if (d.data) {
                if (currentDataMode === 'questionnaire') {
                    content += `<br>æè¿°: ${d.data.description.substring(0, 80)}...`;
                    content += `<br>å¿…å¡«: ${d.data.required}`;
                } else {
                    content += `<br>å†…å®¹: ${d.data.clause_content.substring(0, 80)}...`;
                    content += `<br>ç±»å‹: ${d.data.mandatory_optional}`;
                }
            }
            
            tooltip.innerHTML = content;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        // æ‹–æ‹½å‡½æ•°
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // é‡ç½®è§†å›¾
        function resetView() {
            if (svg) {
                svg.transition().duration(750)
                    .call(d3.zoom().transform, d3.zoomIdentity);
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(filteredData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `esg_${currentDataMode}_filtered.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´
        window.addEventListener('resize', function() {
            if (svg) {
                const container = document.getElementById('graphCanvas');
                const rect = container.getBoundingClientRect();
                svg.attr('width', rect.width).attr('height', rect.height);
                simulation.force('center', d3.forceCenter(rect.width / 2, rect.height / 2));
                simulation.alpha(1).restart();
            }
        });
    </script>
</body>
</html>
